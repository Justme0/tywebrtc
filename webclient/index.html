<!doctype html>
<html>

<head>
    <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'>
    <title> webrtc test </title>
    <style type="text/css">
        .room {
            cursor: pointer;
        }

        div.select {
            display: inline-block;
            margin: 0 0 1em 0;
        }
    </style>


    <script type='text/javascript'>

        window.localStorage.setItem('debug', '*');

        async function publish() {
            console.log("shit")

            let videoElement = document.getElementById('video_container_publish');
            let streamid = document.getElementById("streamid").value;
            let serverurl = document.getElementById("serverurl").value;

            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                console.error('the getUserMedia is not supported')
                return;
            }

            const constraints = {
                video: { width: { exact: 640 }, height: { exact: 480 } },
                audio: true
            }

            console.log("to get media")
            const stream = await navigator.mediaDevices.getUserMedia(constraints);

            console.log("to get media done")
            videoElement.srcObject = stream;

            var pc = new RTCPeerConnection();

            await pc.addTransceiver(stream.getAudioTracks()[0], {
                direction: "sendrecv",
                streams: [stream],
            });
            await pc.addTransceiver(stream.getVideoTracks()[0], {
                direction: "sendrecv",
                streams: [stream],
            });


            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);


            console.log("=============== offer sdp:");
            console.log(offer.sdp);

            let answerSDP = `v=0
o=- 7595655801978680453 2 IN IP4 127.0.0.1
s=-
t=0 0
a=ice-lite
a=group:BUNDLE 0 1
a=msid-semantic: WMS 5Y2wZK8nANNAoVw6dSAHVjNxrD1ObBM2kBPV
m=audio 9 UDP/TLS/RTP/SAVPF 111 103 104 9 0 8 126
c=IN IP4 0.0.0.0
a=rtcp:9 IN IP4 0.0.0.0
a=candidate:1 1 udp 1686052607 127.0.0.1 8000 typ srflx raddr 127.0.0.1 rport 8000 generation 0
a=ice-ufrag:144115262675375852
a=ice-pwd:728c90257276ed9e48aac959
a=fingerprint:sha-256 55:9B:3E:43:91:2D:66:79:0F:B6:84:45:B3:47:3F:56:D4:4C:9E:10:EA:B4:66:C6:64:42:42:4B:5C:CD:FF:2F
a=setup:active
a=mid:0
a=extmap:1 urn:ietf:params:rtp-hdrext:ssrc-audio-level
a=sendrecv
a=rtcp-mux
a=rtpmap:111 opus/48000/2
a=rtcp-fb:111 nack
a=fmtp:111 minptime=20;sprop-stereo=1;stereo=1
a=rtpmap:126 telephone-event/8000
m=video 9 UDP/TLS/RTP/SAVPF 125 107
c=IN IP4 0.0.0.0
a=rtcp:9 IN IP4 0.0.0.0
a=candidate:1 1 udp 1686052607 127.0.0.1 8000 typ srflx raddr 127.0.0.1 rport 8000 generation 0
a=ice-ufrag:144115262675375852
a=ice-pwd:728c90257276ed9e48aac959
a=fingerprint:sha-256 55:9B:3E:43:91:2D:66:79:0F:B6:84:45:B3:47:3F:56:D4:4C:9E:10:EA:B4:66:C6:64:42:42:4B:5C:CD:FF:2F
a=setup:active
a=mid:1
a=extmap:5 urn:ietf:params:rtp-hdrext:toffset
a=extmap:4 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time
a=extmap:7 http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=rtpmap:125 H264/90000
a=rtcp-fb:125 ccm fir
a=rtcp-fb:125 nack
a=rtcp-fb:125 nack pli
a=rtcp-fb:125 rrtr
a=rtcp-fb:125 transport-cc
a=fmtp:125 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42e01f;x-google-start-bitrate=400
a=rtpmap:107 rtx/90000
a=fmtp:107 apt=125
`
            // a=extmap:12 http://www.webrtc.org/experiments/rtp-hdrext/playout-delay
            console.log("=============== answer sdp:");
            console.log(answerSDP)

            let answer = new RTCSessionDescription({
                type: 'answer',
                sdp: answerSDP
            })

            console.log("print answer")
            await pc.setRemoteDescription(answer);
        }

    </script>

</head>

<body>
    <h1>WHIP Demo</h1>
    <br />


    <div>
        <form>
            <input type="text" size="50" id="serverurl" name="serverurl" value="http://localhost:8080"><br><br>
            <input type="text" size="50" id="streamid" name="streamid" value="teststream"><br><br>
        </form>
        <button onclick="publish()">Publish</button>

    </div>


    <div id="conference">
        publish:
        <br />
        <div id="container">
            <video id="video_container_publish" playsinline controls autoplay muted width="640" height="480"></video>
        </div>
        <br />

    </div>



</body>


</html>