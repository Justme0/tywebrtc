<!doctype html>
<html>

<head>
    <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'>
    <link rel="shortcut icon" href="#" />
    <title> webrtc test </title>
    <style type="text/css">
        .room {
            cursor: pointer;
        }

        div.select {
            display: inline-block;
            margin: 0 0 1em 0;
        }
    </style>
</head>

<body>
    <br />
    <div id="conference">
        <div id="container">
            自己 ( self ):
            <br />
            <video id="video_container_publish" playsinline controls autoplay muted width="250" height="250"></video>
            <br />
            <br />
            对方 ( friend ):
            <br />
            <video id="video_container_subscribe" playsinline controls autoplay width="750" height="750"></video>
        </div>

    </div>

    <div>
        <!-- <button onclick="publish()">Publish</button> -->
        <br />

        <!-- 点击对方画面右下角的喇叭按钮，否则听不到对方声音 -->
        <br />
        &nbsp;&nbsp;&nbsp;&nbsp;
        <button onclick="unpublish()">挂电话 ( close )</button>
        <button onclick="sendMessage()">sendMessage</button>
    </div>

    <script type='text/javascript'>
        // ref: https://github.com/webrtc/samples/blob/gh-pages/src/content/peerconnection/pc1/js/main.js
        window.localStorage.setItem('debug', '*');

        async function getRemoteStream(e) {
            let videoElement = document.getElementById('video_container_subscribe');
            console.log(`ontrack recv event=${JSON.stringify(e)}`)
            if (!e.streams) {
                return;
            }

            var downStream = e.streams[0];
            videoElement.srcObject = downStream;

            // should check if audio/video exists
            downStream.getVideoTracks()[0].onmute = (event) => {
                console.log(`video recv onmute=${JSON.stringify(event)}`)
            }

            downStream.getVideoTracks()[0].onunmute = (event) => {
                console.log(`video recv onunmute=${JSON.stringify(event)}`)
            }

            downStream.getAudioTracks()[0].onmute = (event) => {
                console.log(`audio recv onmute=${JSON.stringify(event)}`)
            }

            downStream.getAudioTracks()[0].onunmute = (event) => {
                console.log(`audio recv onunmute=${JSON.stringify(event)}`)
            }
        }

        var pc = null;
        var sendChannel = null;

        function sendMessage() {
            sendChannel.send("taylortest")
        }

        async function unpublish() {
            console.log("To unpublish")
            let videoElement = document.getElementById('video_container_publish');

            const tracks = videoElement.srcObject.getTracks();
            tracks.forEach((track) => {
                track.stop();
            });

            videoElement.srcObject = null;

            pc.close();
            pc = null;
        }

        async function publish() {
            console.log("To publish")

            // 1, publish
            let videoElement = document.getElementById('video_container_publish');
            // let streamid = document.getElementById("streamid").value;
            // let serverurl = document.getElementById("serverurl").value;

            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                console.error('the getUserMedia is not supported')
                return;
            }

            const constraints = {
                video: { frameRate: { exact: 15 }, width: { exact: 450 }, height: { exact: 450 } },
                audio: true
            }

            console.log("to get media")
            const stream = await navigator.mediaDevices.getUserMedia(constraints);

            console.log("to get media done")
            videoElement.srcObject = stream;

            pc = new RTCPeerConnection();

            sendChannel = pc.createDataChannel("sendChannel");
            sendChannel.onopen = () => {
                console.log("data channel opened")
            };
            sendChannel.onclose = () => {
                console.log("data channel closed")
            };
            sendChannel.onerror = error => {
                console.log(`data channel error ${error}`)
            };
            sendChannel.onmessage = event => {
                console.log(`data channel onmessage ${event}`)
            };

            // for uplink
            await pc.addTransceiver(stream.getAudioTracks()[0], {
                direction: "sendrecv",
                streams: [stream],
            });
            await pc.addTransceiver(stream.getVideoTracks()[0], {
                direction: "sendrecv",
                streams: [stream],
            });

            // for downlink
            await pc.addTransceiver("audio", {
                direction: "recvonly",
            });

            await pc.addTransceiver("video", {
                direction: "recvonly",
            });

            // 2, subscribe
            pc.ontrack = getRemoteStream;
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            console.log("=============== offer sdp:");
            console.log(offer.sdp);

            let answerSDP = `v=0
o=- 7595655801978680453 2 IN IP4 127.0.0.1
s=-
t=0 0
a=ice-lite
a=group:BUNDLE 0 1 2 3
a=msid-semantic: WMS 5Y2wZK8nANNAoVw6dSAHVjNxrD1ObBM2kBPV
m=audio 9 UDP/TLS/RTP/SAVPF 111
c=IN IP4 0.0.0.0
a=rtcp:9 IN IP4 0.0.0.0
a=candidate:1 1 udp 1686052607 36.155.205.204 8090 typ srflx raddr 36.155.205.204 rport 8090 generation 0
a=ice-ufrag:144115262675375852
a=ice-pwd:728c90257276ed9e48aac959
a=fingerprint:sha-256 55:9B:3E:43:91:2D:66:79:0F:B6:84:45:B3:47:3F:56:D4:4C:9E:10:EA:B4:66:C6:64:42:42:4B:5C:CD:FF:2F
a=setup:active
a=mid:0
a=extmap:1 urn:ietf:params:rtp-hdrext:ssrc-audio-level
a=recvonly
a=rtcp-mux
a=rtpmap:111 opus/48000/2
a=rtcp-fb:111 nack
a=rtcp-fb:111 rrtr
a=fmtp:111 minptime=20;sprop-stereo=1;stereo=1
m=video 9 UDP/TLS/RTP/SAVPF 96
c=IN IP4 0.0.0.0
a=rtcp:9 IN IP4 0.0.0.0
a=candidate:1 1 udp 1686052607 36.155.205.204 8090 typ srflx raddr 36.155.205.204 rport 8090 generation 0
a=ice-ufrag:144115262675375852
a=ice-pwd:728c90257276ed9e48aac959
a=fingerprint:sha-256 55:9B:3E:43:91:2D:66:79:0F:B6:84:45:B3:47:3F:56:D4:4C:9E:10:EA:B4:66:C6:64:42:42:4B:5C:CD:FF:2F
a=setup:active
a=mid:1
a=extmap:2 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time
a=extmap:14 urn:ietf:params:rtp-hdrext:toffset
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=rtpmap:96 VP8/90000
a=rtcp-fb:96 goog-remb
a=rtcp-fb:96 ccm fir
a=rtcp-fb:96 nack
a=rtcp-fb:96 nack pli
a=rtcp-fb:96 rrtr
m=audio 9 UDP/TLS/RTP/SAVPF 111
c=IN IP4 0.0.0.0
a=rtcp:9 IN IP4 0.0.0.0
a=candidate:1 1 udp 1686052607 36.155.205.204 8090 typ srflx raddr 36.155.205.204 rport 8090 generation 0
a=ice-ufrag:144115262675375852
a=ice-pwd:728c90257276ed9e48aac959
a=fingerprint:sha-256 55:9B:3E:43:91:2D:66:79:0F:B6:84:45:B3:47:3F:56:D4:4C:9E:10:EA:B4:66:C6:64:42:42:4B:5C:CD:FF:2F
a=setup:active
a=mid:2
a=extmap:1 urn:ietf:params:rtp-hdrext:ssrc-audio-level
a=sendonly
a=rtcp-mux
a=rtpmap:111 opus/48000/2
a=rtcp-fb:111 nack
a=rtcp-fb:111 rrtr
a=fmtp:111 minptime=20;sprop-stereo=1;stereo=1
a=ssrc:16854838 cname:YZcxBwerFFm6GH69
a=ssrc:16854838 msid:5Y2wZK8nANNAoVw6dSAHVjNxrD1ObBM2kBPV 128f4fa0-81dd-4c3a-bbcd-22e71e29d178
a=ssrc:16854838 mslabel:5Y2wZK8nANNAoVw6dSAHVjNxrD1ObBM2kBPV
a=ssrc:16854838 label:128f4fa0-81dd-4c3a-bbcd-22e71e29d178
m=video 9 UDP/TLS/RTP/SAVPF 96
c=IN IP4 0.0.0.0
a=rtcp:9 IN IP4 0.0.0.0
a=candidate:1 1 udp 1686052607 36.155.205.204 8090 typ srflx raddr 36.155.205.204 rport 8090 generation 0
a=ice-ufrag:144115262675375852
a=ice-pwd:728c90257276ed9e48aac959
a=fingerprint:sha-256 55:9B:3E:43:91:2D:66:79:0F:B6:84:45:B3:47:3F:56:D4:4C:9E:10:EA:B4:66:C6:64:42:42:4B:5C:CD:FF:2F
a=setup:active
a=mid:3
a=extmap:4 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time
a=extmap:5 urn:ietf:params:rtp-hdrext:toffset
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=rtpmap:96 VP8/90000
a=rtcp-fb:96 goog-remb
a=rtcp-fb:96 ccm fir
a=rtcp-fb:96 nack
a=rtcp-fb:96 nack pli
a=rtcp-fb:96 rrtr
a=ssrc-group:FID 33697348 50472669
a=ssrc:33697348 cname:ovaCctnHP9Asci9c
a=ssrc:33697348 msid:5Y2wZK8nANNAoVw6dSAHVjNxrD1ObBM2kBPV 1d7fc300-9889-4f94-9f35-c0bcc77a260d
a=ssrc:33697348 mslabel:5Y2wZK8nANNAoVw6dSAHVjNxrD1ObBM2kBPV
a=ssrc:33697348 label:1d7fc300-9889-4f94-9f35-c0bcc77a260d
a=ssrc:50472669 cname:ovaCctnHP9Asci9c
a=ssrc:50472669 msid:5Y2wZK8nANNAoVw6dSAHVjNxrD1ObBM2kBPV 1d7fc300-9889-4f94-9f35-c0bcc77a260d
a=ssrc:50472669 mslabel:5Y2wZK8nANNAoVw6dSAHVjNxrD1ObBM2kBPV
a=ssrc:50472669 label:1d7fc300-9889-4f94-9f35-c0bcc77a260d
m=application 9 UDP/DTLS/SCTP webrtc-datachannel
a=ice-ufrag:144115262675375852
a=ice-pwd:728c90257276ed9e48aac959
a=fingerprint:sha-256 55:9B:3E:43:91:2D:66:79:0F:B6:84:45:B3:47:3F:56:D4:4C:9E:10:EA:B4:66:C6:64:42:42:4B:5C:CD:FF:2F
a=setup:active
a=sendrecv
a=mid:4
a=candidate:1 1 udp 1686052607 36.155.205.204 8090 typ srflx raddr 36.155.205.204 rport 8090 generation 0
a=sctpmap:5000 webrtc-datachannel 1024
a=max-message-size:262144
`
            console.log("=============== answer sdp:");
            console.log(answerSDP)

            let answer = new RTCSessionDescription({
                type: 'answer',
                sdp: answerSDP
            })

            console.log("print answer done")
            await pc.setRemoteDescription(answer);
        }


        /*
        document.addEventListener("WeixinJSBridgeReady", () => {
            let videoElement = document.getElementById('video_container_publish');
            videoElement.play()
        }, false);
        */


        // Set up an event listener which will run the startup
        // function once the page is done loading.
        window.addEventListener('load', publish, false);

    </script>
</body>

</html>