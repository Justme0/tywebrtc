<!doctype html>
<html>

<head>
    <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'>
    <title> webrtc test </title>
    <style type="text/css">
        .room {
            cursor: pointer;
        }

        div.select {
            display: inline-block;
            margin: 0 0 1em 0;
        }
    </style>


    <script type='text/javascript'>

        window.localStorage.setItem('debug', '*');

        async function getRemoteStream(e) {
            let videoElement = document.getElementById('video_container_subscribe');
            console.log(`ontrack recv event=${JSON.stringify(e)}`)
            if (!e.streams) {
                return;
            }

            var downStream = e.streams[0];
            videoElement.srcObject = downStream;
        }

        async function publish() {
            console.log("To publish")

            // 1, publish
            let videoElement = document.getElementById('video_container_publish');
            // let streamid = document.getElementById("streamid").value;
            // let serverurl = document.getElementById("serverurl").value;

            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                console.error('the getUserMedia is not supported')
                return;
            }

            const constraints = {
                video: { width: { exact: 640 }, height: { exact: 480 } },
                audio: true
            }

            console.log("to get media")
            const stream = await navigator.mediaDevices.getUserMedia(constraints);

            console.log("to get media done")
            videoElement.srcObject = stream;

            var pc = new RTCPeerConnection();

            // for uplink
            await pc.addTransceiver(stream.getAudioTracks()[0], {
                direction: "sendrecv",
                streams: [stream],
            });
            await pc.addTransceiver(stream.getVideoTracks()[0], {
                direction: "sendrecv",
                streams: [stream],
            });

            // for downlink
            await pc.addTransceiver("audio", {
                direction: "recvonly",
            });

            await pc.addTransceiver("video", {
                direction: "recvonly",
            });

            // 2, subscribe
            pc.ontrack = getRemoteStream;
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            console.log("=============== offer sdp:");
            console.log(offer.sdp);

            let answerSDP = `v=0
o=- 7595655801978680453 2 IN IP4 CANDIDATE_PLACEHOLDER
s=-
t=0 0
a=ice-lite
a=group:BUNDLE 0 1
a=msid-semantic: WMS 5Y2wZK8nANNAoVw6dSAHVjNxrD1ObBM2kBPV
m=audio 9 UDP/TLS/RTP/SAVPF 111 103 104 9 0 8 126
c=IN IP4 0.0.0.0
a=rtcp:9 IN IP4 0.0.0.0
a=candidate:1 1 udp 1686052607 CANDIDATE_PLACEHOLDER 8007 typ srflx raddr CANDIDATE_PLACEHOLDER rport 8007 generation 0
a=ice-ufrag:144115262675375852
a=ice-pwd:728c90257276ed9e48aac959
a=fingerprint:sha-256 55:9B:3E:43:91:2D:66:79:0F:B6:84:45:B3:47:3F:56:D4:4C:9E:10:EA:B4:66:C6:64:42:42:4B:5C:CD:FF:2F
a=setup:active
a=mid:0
a=extmap:1 urn:ietf:params:rtp-hdrext:ssrc-audio-level
a=sendrecv
a=rtcp-mux
a=rtpmap:111 opus/48000/2
a=rtcp-fb:111 nack
a=fmtp:111 minptime=20;sprop-stereo=1;stereo=1
a=rtpmap:126 telephone-event/8000
m=video 9 UDP/TLS/RTP/SAVPF 125 107
c=IN IP4 0.0.0.0
a=rtcp:9 IN IP4 0.0.0.0
a=candidate:1 1 udp 1686052607 CANDIDATE_PLACEHOLDER 8007 typ srflx raddr CANDIDATE_PLACEHOLDER rport 8007 generation 0
a=ice-ufrag:144115262675375852
a=ice-pwd:728c90257276ed9e48aac959
a=fingerprint:sha-256 55:9B:3E:43:91:2D:66:79:0F:B6:84:45:B3:47:3F:56:D4:4C:9E:10:EA:B4:66:C6:64:42:42:4B:5C:CD:FF:2F
a=setup:active
a=mid:1
a=extmap:2 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time
a=extmap:14 urn:ietf:params:rtp-hdrext:toffset
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=rtpmap:125 H264/90000
a=rtcp-fb:125 ccm fir
a=rtcp-fb:125 nack
a=rtcp-fb:125 nack pli
a=rtcp-fb:125 rrtr
a=rtcp-fb:125 remb
a=fmtp:125 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42e01f;x-google-start-bitrate=400
a=rtpmap:107 rtx/90000
a=fmtp:107 apt=125
m=audio 9 UDP/TLS/RTP/SAVPF 111 103 104 9 0 8 126
c=IN IP4 0.0.0.0
a=rtcp:9 IN IP4 0.0.0.0
a=candidate:1 1 udp 1686052607 CANDIDATE_PLACEHOLDER 8007 typ srflx raddr CANDIDATE_PLACEHOLDER rport 8007 generation 0
a=ice-ufrag:144115262675375852
a=ice-pwd:728c90257276ed9e48aac959
a=fingerprint:sha-256 55:9B:3E:43:91:2D:66:79:0F:B6:84:45:B3:47:3F:56:D4:4C:9E:10:EA:B4:66:C6:64:42:42:4B:5C:CD:FF:2F
a=setup:active
a=mid:2
a=extmap:1 urn:ietf:params:rtp-hdrext:ssrc-audio-level
a=sendonly
a=rtcp-mux
a=rtpmap:111 opus/48000/2
a=rtcp-fb:111 nack
a=fmtp:111 minptime=20;sprop-stereo=1;stereo=1
a=rtpmap:126 telephone-event/8000
a=ssrc:16854838 cname:YZcxBwerFFm6GH69
a=ssrc:16854838 msid:5Y2wZK8nANNAoVw6dSAHVjNxrD1ObBM2kBPV 128f4fa0-81dd-4c3a-bbcd-22e71e29d178
a=ssrc:16854838 mslabel:5Y2wZK8nANNAoVw6dSAHVjNxrD1ObBM2kBPV
a=ssrc:16854838 label:128f4fa0-81dd-4c3a-bbcd-22e71e29d178
m=video 9 UDP/TLS/RTP/SAVPF 125 96
c=IN IP4 0.0.0.0
a=rtcp:9 IN IP4 0.0.0.0
a=candidate:1 1 udp 1686052607 CANDIDATE_PLACEHOLDER 8007 typ srflx raddr CANDIDATE_PLACEHOLDER rport 8007 generation 0
a=ice-ufrag:144115262675375852
a=ice-pwd:728c90257276ed9e48aac959
a=fingerprint:sha-256 55:9B:3E:43:91:2D:66:79:0F:B6:84:45:B3:47:3F:56:D4:4C:9E:10:EA:B4:66:C6:64:42:42:4B:5C:CD:FF:2F
a=setup:active
a=mid:3
a=extmap:4 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time
a=extmap:5 urn:ietf:params:rtp-hdrext:toffset
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=rtpmap:125 H264/90000
a=rtcp-fb:125 ccm fir
a=rtcp-fb:125 nack
a=rtcp-fb:125 nack pli
a=rtcp-fb:125 goog-remb
a=rtcp-fb:125 rrtr
a=fmtp:125 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42e01f;sps-pps-idr-in-keyframe=1
a=rtpmap:96 VP8/90000
a=rtcp-fb:96 goog-remb
a=rtcp-fb:96 ccm fir
a=rtcp-fb:96 nack
a=rtcp-fb:96 nack pli
a=rtcp-fb:96 rrtr
a=ssrc-group:FID 33697348 50472669
a=ssrc:33697348 cname:ovaCctnHP9Asci9c
a=ssrc:33697348 msid:5Y2wZK8nANNAoVw6dSAHVjNxrD1ObBM2kBPV 1d7fc300-9889-4f94-9f35-c0bcc77a260d
a=ssrc:33697348 mslabel:5Y2wZK8nANNAoVw6dSAHVjNxrD1ObBM2kBPV
a=ssrc:33697348 label:1d7fc300-9889-4f94-9f35-c0bcc77a260d
a=ssrc:50472669 cname:ovaCctnHP9Asci9c
a=ssrc:50472669 msid:5Y2wZK8nANNAoVw6dSAHVjNxrD1ObBM2kBPV 1d7fc300-9889-4f94-9f35-c0bcc77a260d
a=ssrc:50472669 mslabel:5Y2wZK8nANNAoVw6dSAHVjNxrD1ObBM2kBPV
a=ssrc:50472669 label:1d7fc300-9889-4f94-9f35-c0bcc77a260d
`
            console.log("=============== answer sdp:");
            console.log(answerSDP)

            let answer = new RTCSessionDescription({
                type: 'answer',
                sdp: answerSDP
            })

            console.log("print answer done")
            await pc.setRemoteDescription(answer);
        }

    </script>

</head>

<body>
    <h1>tywebrtc Demo</h1>
    <br />

    <div>
        <!--
        <form>
            <input type="text" size="50" id="serverurl" name="serverurl" value="http://localhost:8080"><br><br>
            <input type="text" size="50" id="streamid" name="streamid" value="teststream"><br><br>
        </form>
        -->
        <button onclick="publish()">Publish</button>

    </div>


    <br />
    <br />
    <div id="conference">
        <div id="container">
            publish:
            <br />
            <video id="video_container_publish" playsinline controls autoplay muted width="240" height="160"></video>
            <br />
            <br />
            subscribe:
            <br />
            <video id="video_container_subscribe" playsinline controls autoplay muted width="480" height="320"></video>
        </div>
        <br />

    </div>
</body>
</html>